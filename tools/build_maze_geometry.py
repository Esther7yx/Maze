"""
build_maze_geometry.py - MVPç‰ˆæœ¬
æˆå‘˜Aï¼šOpenGL ç¨‹åºåŒ–å»ºæ¨¡è„šæœ¬
æœ€å°å¯ç”¨å®ç°ï¼šåªç”Ÿæˆv/usemtl/fï¼Œç¡®ä¿èƒ½è¢«resource_loaderè¯»å–
"""

import os
from typing import List, Tuple

# ======================
# ä¸–ç•Œåæ ‡ä¸å°ºå¯¸çº¦å®š
# ======================

WALL_HEIGHT = 3.0
WALL_THICKNESS = 0.3
CORRIDOR_WIDTH = 2.5

FLOOR_Y = 0.0
FLOOR_THICKNESS = 0.1

ASSET_DIR = "assets/models/"

# ======================
# OBJ æ•°æ®ç»“æ„ - MVPç®€åŒ–ç‰ˆ
# ======================

class OBJMesh:
    """OBJç½‘æ ¼æ•°æ®ç»“æ„ - æœ€å°å¯ç”¨å®ç°"""
    
    def __init__(self, name: str):
        self.name = name
        self.vertices: List[Tuple[float, float, float]] = []  # [(x, y, z), ...]
        
        # æ˜ç¡®è¯­ä¹‰ï¼šfaces åªå­˜ (vertex_index1, vertex_index2, vertex_index3, material_name)
        # ç´¢å¼•ä»0å¼€å§‹ï¼ˆå†…éƒ¨å­˜å‚¨ï¼‰ï¼Œå¯¼å‡ºæ—¶è½¬ä¸º1-basedï¼ˆOBJæ ‡å‡†ï¼‰
        self.faces: List[Tuple[int, int, int, str]] = []
        
        # æè´¨ç®¡ç†ï¼šæ¯ä¸ªé¢ç»‘å®šä¸€ä¸ªæè´¨
        self.materials: Set[str] = set()

# ======================
# åŸºç¡€å‡ ä½•ç”Ÿæˆå‡½æ•° - MVPç®€åŒ–ç‰ˆ
# ======================

def add_box(mesh: OBJMesh, center, size, material):
    """
    ç”Ÿæˆä¸€ä¸ªè½´å¯¹é½é•¿æ–¹ä½“ï¼ˆAABBï¼‰
    - center: (cx, cy, cz)
    - size: (sx, sy, sz)
    """
    cx, cy, cz = center
    sx, sy, sz = size

    hx, hy, hz = sx / 2, sy / 2, sz / 2

    # 8 ä¸ªé¡¶ç‚¹
    v = [
        (cx - hx, cy - hy, cz - hz),
        (cx + hx, cy - hy, cz - hz),
        (cx + hx, cy + hy, cz - hz),
        (cx - hx, cy + hy, cz - hz),
        (cx - hx, cy - hy, cz + hz),
        (cx + hx, cy - hy, cz + hz),
        (cx + hx, cy + hy, cz + hz),
        (cx - hx, cy + hy, cz + hz),
    ]

    start_index = len(mesh.vertices)  # åº”è¯¥æ˜¯å½“å‰é¡¶ç‚¹æ•°é‡ï¼Œä¸æ˜¯+1
    mesh.vertices.extend(v)

    # 12 ä¸ªä¸‰è§’å½¢ï¼ˆä¸¤ä¸ªä¸€ç»„ï¼Œç»„æˆä¸€ä¸ªé¢ï¼‰
    faces = [
        # front (-Z)
        (0, 1, 2), (0, 2, 3),
        # back (+Z)
        (4, 6, 5), (4, 7, 6),
        # left (-X)
        (0, 3, 7), (0, 7, 4),
        # right (+X)
        (1, 5, 6), (1, 6, 2),
        # top (+Y)
        (3, 2, 6), (3, 6, 7),
        # bottom (-Y)
        (0, 4, 5), (0, 5, 1),
    ]

    for a, b, c in faces:
        mesh.faces.append((
            start_index + a + 1,  # OBJæ˜¯1-basedç´¢å¼•
            start_index + b + 1,
            start_index + c + 1,
            material
        ))

def add_floor_plane(mesh: OBJMesh, center_x, center_z, width, depth, material):
    """
    ç”Ÿæˆ y = 0 çš„åœ°é¢çŸ©å½¢ï¼ˆ2 ä¸ªä¸‰è§’å½¢ï¼‰
    """
    hx = width / 2
    hz = depth / 2
    y = 0.0

    v = [
        (center_x - hx, y, center_z - hz),
        (center_x + hx, y, center_z + hz),
        (center_x + hx, y, center_z - hz),
        (center_x - hx, y, center_z + hz),
    ]

    start_index = len(mesh.vertices)  # åº”è¯¥æ˜¯å½“å‰é¡¶ç‚¹æ•°é‡ï¼Œä¸æ˜¯+1
    mesh.vertices.extend(v)

    # ä¸¤ä¸ªä¸‰è§’å½¢ï¼ˆæ³¨æ„ï¼šæ­£ç¡®çš„é¡¶ç‚¹è¿æ¥é¡ºåºï¼‰
    # ç¬¬ä¸€ä¸ªä¸‰è§’å½¢ï¼šv0 -> v1 -> v2
    # ç¬¬äºŒä¸ªä¸‰è§’å½¢ï¼šv0 -> v2 -> v3
    mesh.faces.append((start_index + 1, start_index + 2, start_index + 3, material))
    mesh.faces.append((start_index + 1, start_index + 3, start_index + 4, material))

# ======================
# OBJ å¯¼å‡ºå‡½æ•° - MVPç®€åŒ–ç‰ˆ
# ======================

def export_obj(mesh: OBJMesh, filepath: str):
    os.makedirs(os.path.dirname(filepath), exist_ok=True)

    with open(filepath, "w", encoding="utf-8") as f:
        f.write(f"# OBJ generated by build_maze_geometry.py\n")
        f.write(f"o {mesh.name}\n\n")

        # å†™é¡¶ç‚¹
        for v in mesh.vertices:
            f.write(f"v {v[0]} {v[1]} {v[2]}\n")

        f.write("\n")

        current_material = None
        for i1, i2, i3, material in mesh.faces:
            if material != current_material:
                f.write(f"usemtl {material}\n")
                current_material = material
            f.write(f"f {i1} {i2} {i3}\n")

# ======================
# è¿·å®«ç»“æ„æ„å»ºå‡½æ•°
# ======================

def build_start_area(mesh_walls: OBJMesh, mesh_floor: OBJMesh):
    """æ„å»ºèµ·ç‚¹åŒºåŸŸ"""
    # åœ°é¢ (6x6)
    add_floor_plane(mesh_floor, 0, 0, 6, 6, "FLOOR_GROUND")
    
    # å›´å¢™ï¼ˆç•™+Xæ–¹å‘å‡ºå£ï¼‰
    add_box(mesh_walls, (0, WALL_HEIGHT/2, 3), (6, WALL_HEIGHT, WALL_THICKNESS), "WALL_STONE")  # åŒ—å¢™
    add_box(mesh_walls, (0, WALL_HEIGHT/2, -3), (6, WALL_HEIGHT, WALL_THICKNESS), "WALL_STONE")  # å—å¢™
    add_box(mesh_walls, (-3, WALL_HEIGHT/2, 0), (WALL_THICKNESS, WALL_HEIGHT, 6), "WALL_STONE")  # è¥¿å¢™

def build_main_corridor(mesh_walls: OBJMesh, mesh_floor: OBJMesh):
    """æ„å»ºä¸»é€šé“1ï¼ˆæ•™å­¦èµ°å»Šï¼‰"""
    corridor_length = 10
    corridor_center_x = 3 + corridor_length / 2
    
    # åœ°é¢
    add_floor_plane(mesh_floor, corridor_center_x, 0, corridor_length, CORRIDOR_WIDTH, "FLOOR_GROUND")
    
    # å·¦å³å¢™
    wall_z_offset = CORRIDOR_WIDTH / 2 + WALL_THICKNESS / 2
    add_box(mesh_walls, (corridor_center_x, WALL_HEIGHT/2, -wall_z_offset), 
            (corridor_length, WALL_HEIGHT, WALL_THICKNESS), "WALL_STONE")  # å·¦å¢™
    add_box(mesh_walls, (corridor_center_x, WALL_HEIGHT/2, wall_z_offset), 
            (corridor_length, WALL_HEIGHT, WALL_THICKNESS), "WALL_STONE")  # å³å¢™

def build_torch_zone(mesh_floor: OBJMesh, mesh_torch: OBJMesh):
    """æ„å»ºç«æŠŠæ•™å­¦åŒº"""
    # ç«æŠŠåŸºåº§ï¼ˆå°ç«‹æ–¹ä½“ï¼‰
    torch_position = (13, 0.6, 0)  # ç¨å¾®æŠ¬é«˜
    torch_size = (0.5, 1.2, 0.5)
    add_box(mesh_torch, torch_position, torch_size, "EMISSIVE_TORCH")
    
    # è¿æ¥åŒºåŸŸçš„åœ°é¢
    add_floor_plane(mesh_floor, 13, 0, 4, 4, "FLOOR_GROUND")

def build_dead_end(mesh_walls: OBJMesh, mesh_floor: OBJMesh):
    """æ„å»ºå‡è·¯ï¼ˆæ­»è·¯ï¼‰"""
    dead_end_length = 6
    dead_end_center_z = dead_end_length / 2
    
    # åœ°é¢
    add_floor_plane(mesh_floor, 10, dead_end_center_z, CORRIDOR_WIDTH, dead_end_length, "FLOOR_GROUND")
    
    # å·¦å³å¢™
    wall_x_offset = CORRIDOR_WIDTH / 2 + WALL_THICKNESS / 2
    add_box(mesh_walls, (10 - wall_x_offset, WALL_HEIGHT/2, dead_end_center_z), 
            (WALL_THICKNESS, WALL_HEIGHT, dead_end_length), "WALL_STONE")  # å·¦å¢™
    add_box(mesh_walls, (10 + wall_x_offset, WALL_HEIGHT/2, dead_end_center_z), 
            (WALL_THICKNESS, WALL_HEIGHT, dead_end_length), "WALL_STONE")  # å³å¢™
    
    # æœ«ç«¯å°å¢™
    add_box(mesh_walls, (10, WALL_HEIGHT/2, dead_end_length), 
            (CORRIDOR_WIDTH + WALL_THICKNESS * 2, WALL_HEIGHT, WALL_THICKNESS), "WALL_STONE")

def build_pressure_plate_zone(mesh_floor: OBJMesh, mesh_plate: OBJMesh):
    """æ„å»ºå‹åŠ›æ¿åŒº"""
    # å‹åŠ›æ¿ï¼ˆç¨å¾®é«˜äºåœ°é¢ï¼‰
    plate_position = (16, 0.1, -4)
    plate_size = (1.5, 0.2, 1.5)
    add_box(mesh_plate, plate_position, plate_size, "PLATE_METAL")
    
    # è¿æ¥åŒºåŸŸçš„åœ°é¢
    add_floor_plane(mesh_floor, 16, -4, 4, 4, "FLOOR_GROUND")

def build_gate_zone(mesh_gate: OBJMesh):
    """æ„å»ºé“é—¨åŒº"""
    # é“é—¨ï¼ˆå®Œå…¨æŒ¡è·¯ï¼‰
    gate_position = (18, WALL_HEIGHT/2, -4)
    gate_size = (2.5, 3.0, 0.3)
    add_box(mesh_gate, gate_position, gate_size, "METAL_GATE")

def build_core_and_end(mesh_walls: OBJMesh, mesh_floor: OBJMesh):
    """æ„å»ºæ ¸å¿ƒåŒº + ç»ˆç‚¹åŒº"""
    # æ ¸å¿ƒåŒºåœ°é¢ (8x8)
    add_floor_plane(mesh_floor, 22, -4, 8, 8, "FLOOR_GROUND")
    
    # æ ¸å¿ƒåŒºå›´å¢™
    add_box(mesh_walls, (22, WALL_HEIGHT/2, 0), (8, WALL_HEIGHT, WALL_THICKNESS), "WALL_STONE")  # åŒ—å¢™
    add_box(mesh_walls, (22, WALL_HEIGHT/2, -8), (8, WALL_HEIGHT, WALL_THICKNESS), "WALL_STONE")  # å—å¢™
    add_box(mesh_walls, (18, WALL_HEIGHT/2, -4), (WALL_THICKNESS, WALL_HEIGHT, 8), "WALL_STONE")  # è¥¿å¢™
    add_box(mesh_walls, (26, WALL_HEIGHT/2, -4), (WALL_THICKNESS, WALL_HEIGHT, 8), "WALL_STONE")  # ä¸œå¢™
    
    # ç»ˆç‚¹åŒºåœ°é¢ (6x6)
    add_floor_plane(mesh_floor, 30, -4, 6, 6, "FLOOR_GROUND")
    
    # ç»ˆç‚¹åŒºå›´å¢™ï¼ˆæ— å‡ºå£ï¼‰
    add_box(mesh_walls, (30, WALL_HEIGHT/2, -1), (6, WALL_HEIGHT, WALL_THICKNESS), "WALL_STONE")  # åŒ—å¢™
    add_box(mesh_walls, (30, WALL_HEIGHT/2, -7), (6, WALL_HEIGHT, WALL_THICKNESS), "WALL_STONE")  # å—å¢™
    add_box(mesh_walls, (27, WALL_HEIGHT/2, -4), (WALL_THICKNESS, WALL_HEIGHT, 6), "WALL_STONE")  # è¥¿å¢™
    add_box(mesh_walls, (33, WALL_HEIGHT/2, -4), (WALL_THICKNESS, WALL_HEIGHT, 6), "WALL_STONE")  # ä¸œå¢™

# ======================
# ä¸»å‡½æ•°
# ======================

def main():
    """ä¸€é”®ç”Ÿæˆæ‰€æœ‰ OBJ æ–‡ä»¶"""
    print("=== MazeGame ç¨‹åºåŒ–å»ºæ¨¡å·¥å…· - MVPç‰ˆæœ¬ ===")
    print("å¼€å§‹ç”Ÿæˆè¿·å®«å‡ ä½•æ¨¡å‹...\n")
    
    # åˆå§‹åŒ– mesh
    maze_walls = OBJMesh("maze_walls")
    maze_floor = OBJMesh("maze_floor")
    torch_mesh = OBJMesh("torch_holder")
    plate_mesh = OBJMesh("pressure_plate")
    gate_mesh = OBJMesh("door_gate")
    
    # æ„å»ºè¿·å®«
    print("æ„å»ºèµ·ç‚¹åŒº...")
    build_start_area(maze_walls, maze_floor)
    
    print("æ„å»ºä¸»é€šé“...")
    build_main_corridor(maze_walls, maze_floor)
    
    print("æ„å»ºç«æŠŠåŒº...")
    build_torch_zone(maze_floor, torch_mesh)
    
    print("æ„å»ºå‡è·¯...")
    build_dead_end(maze_walls, maze_floor)
    
    print("æ„å»ºå‹åŠ›æ¿åŒº...")
    build_pressure_plate_zone(maze_floor, plate_mesh)
    
    print("æ„å»ºé“é—¨åŒº...")
    build_gate_zone(gate_mesh)
    
    print("æ„å»ºæ ¸å¿ƒåŒºä¸ç»ˆç‚¹åŒº...")
    build_core_and_end(maze_walls, maze_floor)
    
    # å¯¼å‡º OBJ
    print("\nå¯¼å‡ºOBJæ–‡ä»¶...")
    export_obj(maze_walls, ASSET_DIR + "maze_walls.obj")
    export_obj(maze_floor, ASSET_DIR + "maze_floor.obj")
    export_obj(torch_mesh, ASSET_DIR + "torch_holder.obj")
    export_obj(plate_mesh, ASSET_DIR + "pressure_plate.obj")
    export_obj(gate_mesh, ASSET_DIR + "door_gate.obj")
    
    print("\nğŸ‰ è¿·å®«å‡ ä½•æ¨¡å‹ç”Ÿæˆå®Œæˆï¼")
    print(f"- å¢™å£æ¨¡å‹: {len(maze_walls.vertices)} é¡¶ç‚¹, {len(maze_walls.faces)} é¢")
    print(f"- åœ°é¢æ¨¡å‹: {len(maze_floor.vertices)} é¡¶ç‚¹, {len(maze_floor.faces)} é¢")
    print(f"- ç«æŠŠæ¨¡å‹: {len(torch_mesh.vertices)} é¡¶ç‚¹, {len(torch_mesh.faces)} é¢")
    print(f"- å‹åŠ›æ¿: {len(plate_mesh.vertices)} é¡¶ç‚¹, {len(plate_mesh.faces)} é¢")
    print(f"- é“é—¨: {len(gate_mesh.vertices)} é¡¶ç‚¹, {len(gate_mesh.faces)} é¢")

if __name__ == "__main__":
    main()